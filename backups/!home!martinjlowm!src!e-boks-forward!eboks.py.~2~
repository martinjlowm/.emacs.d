import hashlib, binascii, httplib, datetime, re
# Primary = CPR
# Secondary = PW
CPR = "1105921701"
PW = "1337madsen"
nationality = "DK"
activationCode = "Ci2w5X6N"

deviceID = "960db7ecf5f91d7f"
currentTime = datetime.datetime.now().strftime("%Y-%m-%d %I:%M:%S") + "Z";


# challenge = "%s:%s:%s:%s:%s" % (CPR, deviceID, activationCode, PW, currentTime)
challenge = "%s:%s:%s:%s:%s:%s:%s" % (activationCode, deviceID, "P", CPR, nationality, PW, currentTime)
# challenge = "Ci2w5X6N:960db7ecf5f91d7f:P:1105921701:DK:1337madsen:2014-12-21 08:19:57Z"
# print challenge

h = hashlib.sha256()
h.update(challenge)
partOne = h.hexdigest()
h = hashlib.sha256()
h.update(partOne)
partTwo = h.hexdigest()

headers = {
    "X-EBOKS-AUTHENTICATE": 'logon deviceid="%s",datetime="%s",challenge="%s"' % (deviceID, currentTime, partTwo),
    "Content-type": "application/xml",
    "charset": "utf-8"
}
params = '<Logon xmlns="urn:eboks:mobile:1.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">\
    <App Device="A0001" os="android" osVersion="4.4.4" version="1.4.2"/>\
    <User identity="%s" identityType="P" nationality="%s" pincode="%s"/>\
</Logon>' % (CPR, nationality, PW)
c = httplib.HTTPSConnection("rest.e-boks.dk")
c.request("PUT", "/mobile/1/xml.svc/en-gb/session", params, headers)
response = c.getresponse()
# print response.status, response.reason
data = response.read()
# print data

headers = response.getheaders()
for k, v in headers:
    if k == "x-eboks-authenticate":
        m = re.search('sessionid="([a-f0-9-]+)", nonce="([a-f0-9]+)"', v)
        session = m.group(1)
        nonce = m.group(2)
print session
print nonce

headers = {
    "X-EBOKS-AUTHENTICATE": 'deviceid="%s",nonce="%s",sessionid="%s",response="%s"' % (deviceID, nonce, session, partTwo),
    "Content-type": "application/xml",
    "charset": "utf-8"
}

# c.request("PUT", "/mobile/1/xml.svc/en-gb/4299841/0/overview?profilecompleteness=true", params, headers)
c.request("GET", "/mobile/1/xml.svc/en-gb/4299841/0/mail/folder/0/message/2014A12A15A13B45B14B902972/content", params, headers)
response = c.getresponse()
print response.status, response.reason
data = response.read()

with open('test_one.pdf', 'wb') as f:
    f.write(data)
